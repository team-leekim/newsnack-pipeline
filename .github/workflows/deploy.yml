name: Deploy Newsnack Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'dags/**'
      - 'src/**'
      - 'requirements.txt'
      - 'setup.py'
      - 'pyproject.toml'
      - 'MANIFEST.in'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.dockerignore'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install minimal dependencies for validation
        run: |
          pip install pyyaml sqlalchemy
          pip install -e .
      
      - name: Validate DAG syntax
        run: |
          for dag in dags/*.py; do
            if [ -f "$dag" ]; then
              echo "âœ“ Validating $dag..."
              python -c "import py_compile; py_compile.compile('$dag', doraise=True)" || exit 1
            fi
          done
          echo "âœ… All DAG files are valid"
      
      - name: Check if package config changed
        id: check_requirements
        run: |
          set -e
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [ -n "$BEFORE" ] && [ "$BEFORE" != "0000000000000000000000000000000000000000" ]; then
            CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          else
            CHANGED="$(git diff --name-only HEAD^ HEAD || true)"
          fi

          echo "Changed files:"
          echo "$CHANGED"

          if echo "$CHANGED" | grep -Eq '(requirements\.txt|setup\.py|pyproject\.toml|MANIFEST\.in|Dockerfile|docker-compose\.yml|\.dockerignore)'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Package configuration has changed - image rebuild required"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
      
      - name: Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy DAG files
        run: |
          echo "ğŸ“¦ Deploying DAG files..."
          # dags/ ë””ë ‰í† ë¦¬ ë°°í¬
          rsync -avz --delete \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.DS_Store' \
            dags/ ec2-user@${{ secrets.EC2_HOST }}:~/newsnack-pipeline/dags/
          
          echo "ğŸ“¦ Deploying source code..."
          # src/ ë””ë ‰í† ë¦¬ ë°°í¬
          rsync -avz --delete \
            --no-times --no-perms --no-owner --no-group \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.DS_Store' \
            src/ ec2-user@${{ secrets.EC2_HOST }}:~/newsnack-pipeline/src/
      
      - name: Deploy package files if changed
        if: steps.check_requirements.outputs.changed == 'true'
        run: |
          echo "ğŸ“¦ Deploying package configuration files..."
          scp requirements.txt setup.py pyproject.toml MANIFEST.in Dockerfile .dockerignore docker-compose.yml ec2-user@${{ secrets.EC2_HOST }}:~/newsnack-pipeline/
      
      - name: Rebuild and restart Airflow containers if package changed
        if: steps.check_requirements.outputs.changed == 'true'
        run: |
          echo "ğŸ”„ Rebuilding Airflow image (package configuration changed)..."
          ssh ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/newsnack-pipeline
            docker build -t newsnack-pipeline:latest .
            docker compose down
            docker compose up -d --no-build
            sleep 15
            docker compose ps
            docker compose exec -T airflow-scheduler pip list | grep newsnack-etl || true
          EOF
          echo "âœ… Image rebuilt and containers restarted successfully"
      
      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          ssh ec2-user@${{ secrets.EC2_HOST }} '
            echo "ğŸ“ Deployed DAG files:"
            ls -lh ~/newsnack-pipeline/dags/*.py 2>/dev/null || echo "No DAG files found"
            
            echo ""
            echo "ğŸ“ Deployed source files:"
            find ~/newsnack-pipeline/src -name "*.py" -type f | head -10
            
            echo ""
            echo "ğŸ“Š Airflow Scheduler status:"
            docker compose -f ~/newsnack-pipeline/docker-compose.yml ps airflow-scheduler
            
            echo ""
            echo "ğŸ“‹ Recent DAG processing logs:"
            docker compose -f ~/newsnack-pipeline/docker-compose.yml logs --tail=30 airflow-scheduler | grep -E "DAG|Processing" || echo "No DAG logs yet"
          '
      
      - name: Notify deployment
        if: success()
        run: |
          echo "================================"
          echo "âœ… Airflow DAGs deployed successfully!"
          echo "================================"
          echo "ğŸ“ Server: ${{ secrets.EC2_HOST }}"
          echo "ğŸ•’ Time: $(date)"
          echo "ğŸ”— Airflow UI: http://${{ secrets.EC2_HOST }}:8081"
          if [ "${{ steps.check_requirements.outputs.changed }}" == "true" ]; then
            echo "âš ï¸  Requirements changed - containers were restarted"
          fi
          echo "================================"
