name: Deploy Newsnack Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'dags/**'
      - 'src/**'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'MANIFEST.in'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.dockerignore'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: prod
    env:
      EC2_USERNAME: ec2-user
      TARGET_DIR: /home/ec2-user/newsnack-pipeline
      REPOSITORY_URL: git@${{ github.event.repository.name }}:${{ github.repository }}.git
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install minimal dependencies for validation
        run: |
          pip install pyyaml sqlalchemy
          pip install -e .
      
      - name: Validate DAG syntax
        run: |
          for dag in dags/*.py; do
            if [ -f "$dag" ]; then
              echo "âœ“ Validating $dag..."
              python -c "import py_compile; py_compile.compile('$dag', doraise=True)" || exit 1
            fi
          done
          echo "âœ… All DAG files are valid"
      
      - name: Check if package config changed
        id: check_requirements
        run: |
          set -e
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [ -n "$BEFORE" ] && [ "$BEFORE" != "0000000000000000000000000000000000000000" ]; then
            CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          else
            CHANGED="$(git diff --name-only HEAD^ HEAD || true)"
          fi

          echo "Changed files:"
          echo "$CHANGED"

          if echo "$CHANGED" | grep -Eq '(requirements\.txt|pyproject\.toml|MANIFEST\.in|Dockerfile|docker-compose\.yml|\.dockerignore)'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Package configuration has changed - image rebuild required"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy and Verify
        uses: appleboy/ssh-action@v1.2.4
        env:
          CHANGED: ${{ steps.check_requirements.outputs.changed }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ env.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: CHANGED, TARGET_DIR, REPOSITORY_URL
          script: |
            set -e
            
            # 0. ë¦¬í¬ì§€í† ë¦¬ ë³µì œ (í•„ìš” ì‹œ)
            if [ ! -d "$TARGET_DIR" ]; then
              echo "ğŸš€ Cloning repository..."
              git clone $REPOSITORY_URL $TARGET_DIR
            fi
            
            cd $TARGET_DIR
            
            # 1. Pull latest code
            echo "ğŸ“¥ Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main
            
            # 2. Update containers based on changes
            if [ "$CHANGED" == "true" ]; then
              echo "ğŸ”„ Configuration changed. Rebuilding and recreating containers..."
              docker compose down
              docker compose up -d --build
            else
              echo "âœ… Only code changed. Restarting services to apply changes..."
              docker compose up -d
            fi

            # 3. Verify deployment
            echo "ğŸ” Verifying deployment..."
            sleep 15
            docker compose ps
            docker compose exec -T airflow-scheduler pip list | grep newsnack-etl || true
            
            echo "ğŸ“ Current Commit:"
            git log -1 --oneline
            
            echo ""
            echo "ğŸ“Š Airflow Containers Status:"
            docker compose ps
            
            # Prune unused images
            docker image prune -f
      
      - name: Notify deployment
        if: success()
        run: |
          echo "================================"
          echo "âœ… Airflow DAGs deployed successfully!"
          echo "================================"
          echo "ğŸ“ Server: ${{ secrets.EC2_HOST }}"
          echo "ğŸ•’ Time: $(date)"
          echo "ğŸ”— Airflow UI: http://${{ secrets.EC2_HOST }}:8081"
          if [ "${{ steps.check_requirements.outputs.changed }}" == "true" ]; then
            echo "âš ï¸  Requirements changed - containers were restarted"
          fi
          echo "================================"
